{"version":3,"sources":["main.js","/source/main.js"],"names":["initApp","ko","applyBindings","app","viewModel","lastQueryLocation","google","maps","LatLng","lat","lng","GOOGLE_MAP_OPTIONS","zoom","center","mapTypeId","MapTypeId","ROADMAP","mapTypeControl","streetViewControl","map","Map","document","getElementById","model","navigator","geolocation","getCurrentPosition","position","pos","coords","latitude","longitude","controller","removeAllPlaces","setCenter","addListener","_","throttle","loadPlaces","isZoomedOut","distance","geometry","spherical","computeDistanceBetween","isLoading","FoursquareRequestOptions","ll","radius","section","client_id","client_secret","v","$","get","addPlaces","fail","isFailureModalVisible","always","Place","item","venue","location","name","this","stash","isSelected","observable","marker","Marker","icon","G_MARKER","onClickMarker","res","response","groups","items","forEach","placesHash","has","id","place","places","push","set","markers","length","removePlacesFromStart","N","i","shift","setMap","placeDetails","onClickPlace","oldSelected","setIcon","isPlaceDetailsVisible","select","panTo","window","matchMedia","matches","removeClass","filterMarkers","filteredPlaces","path","fillColor","fillOpacity","scale","strokeColor","strokeWeight","G_MARKER_SELECTED","googleError","addClass","observableArray","extend","rateLimit","WeakMap","hidePlaceDetails","hideFailureModal","textFilter","pureComputed","text","trim","toLowerCase","filter","indexOf","isPlacesNotLoaded","prototype"],"mappings":"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","file":"main.js","sourcesContent":["'use strict'; /* eslint-env browser */\n(function () {\n  'use strict';\n\n  var app = {};\n  var lastQueryLocation = void 0;\n\n  // google map markers\n  var G_MARKER = {\n    path: 'M0-48c-9.8 0-17.7 7.8-17.7 17.4 0 15.5 17.7 30.6 17.7 30.6s17.7-15.4 17.7-30.6c0-9.6-7.9-17.4-17.7-17.4z',\n    fillColor: '#607d8b',\n    fillOpacity: 0.7,\n    scale: 0.7,\n    strokeColor: '#607d8b',\n    strokeWeight: 3 };\n\n  var G_MARKER_SELECTED = {\n    path: 'M0-48c-9.8 0-17.7 7.8-17.7 17.4 0 15.5 17.7 30.6 17.7 30.6s17.7-15.4 17.7-30.6c0-9.6-7.9-17.4-17.7-17.4z',\n    fillColor: '#009688',\n    fillOpacity: 0.8,\n    scale: 0.8,\n    strokeColor: '#009688',\n    strokeWeight: 3 };\n\n\n  /* CONTROLLER */\n  app.controller = {\n    initApp: initApp,\n    loadPlaces: loadPlaces, // load places from Foursquare\n\n    onClickPlace: onClickPlace, // handle sidebar clicks\n    onClickMarker: onClickMarker, // handle map clicks\n\n    addPlaces: addPlaces,\n    removePlacesFromStart: removePlacesFromStart,\n    removeAllPlaces: removeAllPlaces,\n\n    googleError: function googleError() {\n      $('#failure-modal-google').addClass('is-visible');\n    } };\n\n\n  /* MODEL */\n  app.model = {\n    map: null, // google map object\n\n    places: ko.observableArray([]).extend({ rateLimit: 100 }), // main places storage\n    placesHash: new Map(), // helps to search place from foursquare place id\n    markers: new WeakMap() // helps to search place from google marker\n  };\n\n  /* VIEW MODEL*/\n  app.viewModel = {\n    //Selected place\n    placeDetails: ko.observable(),\n    isPlaceDetailsVisible: ko.observable(false),\n    hidePlaceDetails: function hidePlaceDetails() {app.viewModel.isPlaceDetailsVisible(false);},\n\n    // error message\n    isFailureModalVisible: ko.observable(false),\n    hideFailureModal: function hideFailureModal() {app.viewModel.isFailureModalVisible(false);},\n\n    textFilter: ko.observable(''),\n\n    filteredPlaces: ko.pureComputed(function () {\n      var filteredPlaces = void 0;\n      var text = app.viewModel.textFilter().trim().toLowerCase(),\n      places = app.model.places();\n      if (text) {\n        filteredPlaces = places.filter(function (place) {return place.name.toLowerCase().indexOf(text) !== -1;});\n      } else {\n        filteredPlaces = places; // show all if search field is empty\n      }\n\n      filterMarkers(filteredPlaces);\n\n      return filteredPlaces;\n    }),\n\n    isPlacesNotLoaded: ko.pureComputed(function () {return !app.model.places().length;}),\n\n    // show spinner?\n    isLoading: ko.observable(false),\n\n    isZoomedOut: ko.observable(false),\n\n    onClickPlace: app.controller.onClickPlace };\n\n\n  /**\n                                                  *  create a map, add map listener\n                                                  */\n  function initApp() {\n    ko.applyBindings(app.viewModel);\n    lastQueryLocation = new google.maps.LatLng({ lat: 0, lng: 0 });\n\n    // init google map\n    var GOOGLE_MAP_OPTIONS = {\n      zoom: 16,\n      center: new google.maps.LatLng(37.7703706, -122.3871226),\n      mapTypeId: google.maps.MapTypeId.ROADMAP,\n      mapTypeControl: false,\n      streetViewControl: false };\n\n    var map = new google.maps.Map(document.getElementById('google-map'), GOOGLE_MAP_OPTIONS);\n    app.model.map = map;\n\n    // Try HTML5 geolocation\n    if (navigator.geolocation) {\n      navigator.geolocation.getCurrentPosition(function (position) {\n        var pos = {\n          lat: position.coords.latitude,\n          lng: position.coords.longitude };\n\n\n        app.controller.removeAllPlaces();\n        map.setCenter(pos);\n      }, function () {\n        //handleLocationError\n      });\n    } else {\n        // Browser doesn't support Geolocation\n      }\n\n    map.addListener('bounds_changed', _.throttle(app.controller.loadPlaces, 2000));\n  }\n\n  /**\n     * load places from 4square\n     */\n  function loadPlaces() {\n    var map = app.model.map;\n    app.viewModel.isZoomedOut(map.zoom < 15);\n\n    // dont ask 4square on big areas\n    if (map.zoom < 15) return;\n\n    //distance between this point and last request\n    var distance = google.maps.geometry.spherical.computeDistanceBetween(lastQueryLocation, map.center);\n    // don't load new data if point is too close to previous search\n    if (distance < 1500) return;\n    lastQueryLocation = map.center;\n    app.viewModel.isLoading(true);\n\n    // load data from foursquare\n    //TODO idea, calculate radius from map zoom\n    var FoursquareRequestOptions = {\n      ll: map.center.lat() + ',' + map.center.lng(),\n      radius: 2000,\n      section: 'drinks',\n      client_id: 'E54BQ11LCWJ15Q0FH4MELITI2CZQ5KSJOU53TNRARJ3HHNXN',\n      client_secret: 'T4O0ZURMG00IGUTU4NKSQZ4DH0E5LGLMDAE20OJWPXMBD10Y',\n      v: 20161025 };\n\n    $.get('https://api.foursquare.com/v2/venues/explore', FoursquareRequestOptions, app.controller.addPlaces).\n    fail(function () {\n      app.viewModel.isFailureModalVisible(true);\n    }).\n    always(function () {\n      app.viewModel.isLoading(false);\n    });\n  }\n\n  /**\n     * map place constructor\n     * @param item - one place from foursquare API response\n     * @constructor\n     */\n  function Place(item) {\n    var map = app.model.map;\n    var lat = item.venue.location.lat,\n    lng = item.venue.location.lng,\n    name = item.venue.name;\n\n    this.stash = item;\n    this.location = { lat: lat, lng: lng };\n    this.name = name;\n    this.isSelected = ko.observable(false);\n    this.marker = new google.maps.Marker({\n      map: map,\n      position: new google.maps.LatLng(lat, lng),\n      icon: G_MARKER });\n\n    this.marker.addListener('click', app.controller.onClickMarker);\n  }\n\n  /**\n     * change marker icon on place selection\n     */\n  Place.prototype.select = function () {\n    this.marker.setIcon(G_MARKER_SELECTED);\n  };\n\n  /**\n      * add places to the map\n      * @param res - results from foursquare request\n      */\n  function addPlaces(res) {\n    //app.controller.removeAllPlaces();\n\n    res.response.groups[0].items.forEach(function (item) {\n      if (app.model.placesHash.has(item.venue.id)) return; // don't allow to double items on the map\n\n      var place = new Place(item);\n      app.model.places.push(place);\n      app.model.placesHash.set(item.venue.id, place);\n      app.model.markers.set(place.marker, place);\n\n    });\n\n    // not more than 150 markers on the map\n    var length = app.model.places().length;\n    if (length > 150) app.controller.removePlacesFromStart(length - 150);\n\n    app.viewModel.isLoading(false);\n  }\n\n  /**\n     * remove N places form the beginning of tha places array\n     * @param N\n     */\n  function removePlacesFromStart(N) {\n    var place = void 0;\n    for (var i = 0; i < N; i++) {\n      place = app.model.places.shift();\n      place.marker.setMap(null);\n      app.model.placesHash.delete(place.stash.venue.id);\n      if (app.viewModel.placeDetails() === place) app.viewModel.placeDetails(null);\n    }\n  }\n\n  function removeAllPlaces() {\n    var N = app.model.places().length;\n    app.controller.removePlacesFromStart(N);\n  }\n\n  /**\n     * user clicks on a map marker\n     */\n  function onClickMarker() {\n    var place = app.model.markers.get(this);\n    onClickPlace(place);\n  }\n\n  /**\n     * user clicks on a place in the menu\n     */\n  function onClickPlace(place) {\n    var oldSelected = app.viewModel.placeDetails();\n    if (oldSelected === place) return;\n\n    if (oldSelected) {\n      oldSelected.isSelected(false);\n      oldSelected.marker.setIcon(G_MARKER);\n    }\n\n    //add place to selected and show place details modal window\n    place.isSelected(true);\n    app.viewModel.placeDetails(place);\n    app.viewModel.isPlaceDetailsVisible(true);\n\n    // change marker icon and move map to this marker\n    place.select();\n    app.model.map.panTo(place.location);\n\n    // hide side menu on small screens after click\n    if (window.matchMedia('(max-width: 426px)').matches) {\n      $('.mdl-layout__drawer').removeClass('is-visible');\n      $('.mdl-layout__obfuscator').removeClass('is-visible');\n    }\n  };\n\n\n  function filterMarkers(filteredPlaces) {\n    var places = app.model.places();\n    //hide all\n    places.forEach(function (place) {return place.marker.setMap(null);});\n    //show filtered\n    filteredPlaces.forEach(function (place) {return place.marker.setMap(app.model.map);});\n  }\n\n  // express some globals\n  window.initApp = app.controller.initApp;\n  window.googleError = app.controller.googleError;\n\n})();\n//# sourceMappingURL=data:application/json;base64,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QUFuQixDQUEyQixRQUEzQjtBQUNEOztBQUVEO0FBQ0EsVUFBTSxVQUFOLENBQWlCLElBQWpCO0FBQ0EsUUFBSSxTQUFKLENBQWMsWUFBZCxDQUEyQixLQUEzQjtBQUNBLFFBQUksU0FBSixDQUFjLHFCQUFkLENBQW9DLElBQXBDOztBQUVBO0FBQ0EsVUFBTSxNQUFOO0FBQ0EsUUFBSSxLQUFKLENBQVUsR0FBVixDQUFjLEtBQWQsQ0FBb0IsTUFBTSxRQUExQjs7QUFFQTtBQUNBLFFBQUksT0FBTyxVQUFQLENBQWtCLG9CQUFsQixFQUF3QyxPQUE1QyxFQUFxRDtBQUNuRCxRQUFFLHFCQUFGLEVBQXlCLFdBQXpCLENBQXFDLFlBQXJDO0FBQ0EsUUFBRSx5QkFBRixFQUE2QixXQUE3QixDQUF5QyxZQUF6QztBQUNEO0FBQ0Y7OztBQUdELFdBQVMsYUFBVCxDQUF1QixjQUF2QixFQUF1QztBQUNyQyxRQUFNLFNBQVMsSUFBSSxLQUFKLENBQVUsTUFBVixFQUFmO0FBQ0E7QUFDQSxXQUFPLE9BQVAsQ0FBZSxVQUFDLEtBQUQsVUFBVyxNQUFNLE1BQU4sQ0FBYSxNQUFiLENBQW9CLElBQXBCLENBQVgsRUFBZjtBQUNBO0FBQ0EsbUJBQWUsT0FBZixDQUF1QixVQUFDLEtBQUQsVUFBVyxNQUFNLE1BQU4sQ0FBYSxNQUFiLENBQW9CLElBQUksS0FBSixDQUFVLEdBQTlCLENBQVgsRUFBdkI7QUFDRDs7QUFFRDtBQUNBLFNBQU8sT0FBUCxHQUFpQixJQUFJLFVBQUosQ0FBZSxPQUFoQztBQUNBLFNBQU8sV0FBUCxHQUFxQixJQUFJLFVBQUosQ0FBZSxXQUFwQzs7QUFFRCxDQTVSRCIsImZpbGUiOiJtYWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWVudiBicm93c2VyICovXG4oZnVuY3Rpb24gKCkge1xuICAndXNlIHN0cmljdCc7XG5cbiAgY29uc3QgYXBwID0ge307XG4gIGxldCBsYXN0UXVlcnlMb2NhdGlvbjtcblxuICAvLyBnb29nbGUgbWFwIG1hcmtlcnNcbiAgY29uc3QgR19NQVJLRVIgPSB7XG4gICAgcGF0aDogJ00wLTQ4Yy05LjggMC0xNy43IDcuOC0xNy43IDE3LjQgMCAxNS41IDE3LjcgMzAuNiAxNy43IDMwLjZzMTcuNy0xNS40IDE3LjctMzAuNmMwLTkuNi03LjktMTcuNC0xNy43LTE3LjR6JyxcbiAgICBmaWxsQ29sb3I6ICcjNjA3ZDhiJyxcbiAgICBmaWxsT3BhY2l0eTogMC43LFxuICAgIHNjYWxlOiAwLjcsXG4gICAgc3Ryb2tlQ29sb3I6ICcjNjA3ZDhiJyxcbiAgICBzdHJva2VXZWlnaHQ6IDNcbiAgfTtcbiAgY29uc3QgR19NQVJLRVJfU0VMRUNURUQgPSB7XG4gICAgcGF0aDogJ00wLTQ4Yy05LjggMC0xNy43IDcuOC0xNy43IDE3LjQgMCAxNS41IDE3LjcgMzAuNiAxNy43IDMwLjZzMTcuNy0xNS40IDE3LjctMzAuNmMwLTkuNi03LjktMTcuNC0xNy43LTE3LjR6JyxcbiAgICBmaWxsQ29sb3I6ICcjMDA5Njg4JyxcbiAgICBmaWxsT3BhY2l0eTogMC44LFxuICAgIHNjYWxlOiAwLjgsXG4gICAgc3Ryb2tlQ29sb3I6ICcjMDA5Njg4JyxcbiAgICBzdHJva2VXZWlnaHQ6IDNcbiAgfTtcblxuICAvKiBDT05UUk9MTEVSICovXG4gIGFwcC5jb250cm9sbGVyID0ge1xuICAgIGluaXRBcHA6IGluaXRBcHAsXG4gICAgbG9hZFBsYWNlczogbG9hZFBsYWNlcywgICAgICAgICAgIC8vIGxvYWQgcGxhY2VzIGZyb20gRm91cnNxdWFyZVxuXG4gICAgb25DbGlja1BsYWNlOiBvbkNsaWNrUGxhY2UsICAgICAgLy8gaGFuZGxlIHNpZGViYXIgY2xpY2tzXG4gICAgb25DbGlja01hcmtlcjogb25DbGlja01hcmtlciwgICAgICAvLyBoYW5kbGUgbWFwIGNsaWNrc1xuXG4gICAgYWRkUGxhY2VzOiBhZGRQbGFjZXMsXG4gICAgcmVtb3ZlUGxhY2VzRnJvbVN0YXJ0OiByZW1vdmVQbGFjZXNGcm9tU3RhcnQsXG4gICAgcmVtb3ZlQWxsUGxhY2VzOiByZW1vdmVBbGxQbGFjZXMsXG5cbiAgICBnb29nbGVFcnJvcigpIHtcbiAgICAgICQoJyNmYWlsdXJlLW1vZGFsLWdvb2dsZScpLmFkZENsYXNzKCdpcy12aXNpYmxlJyk7XG4gICAgfVxuICB9O1xuXG4gIC8qIE1PREVMICovXG4gIGFwcC5tb2RlbCA9IHtcbiAgICBtYXA6IG51bGwsICAgICAgICAgICAgICAgICAgICAgIC8vIGdvb2dsZSBtYXAgb2JqZWN0XG5cbiAgICBwbGFjZXM6IGtvLm9ic2VydmFibGVBcnJheShbXSkuZXh0ZW5kKHtyYXRlTGltaXQ6IDEwMH0pLCAvLyBtYWluIHBsYWNlcyBzdG9yYWdlXG4gICAgcGxhY2VzSGFzaDogbmV3IE1hcCgpLCAgICAgICAgICAvLyBoZWxwcyB0byBzZWFyY2ggcGxhY2UgZnJvbSBmb3Vyc3F1YXJlIHBsYWNlIGlkXG4gICAgbWFya2VyczogbmV3IFdlYWtNYXAoKSAgICAgICAgICAvLyBoZWxwcyB0byBzZWFyY2ggcGxhY2UgZnJvbSBnb29nbGUgbWFya2VyXG4gIH07XG5cbiAgLyogVklFVyBNT0RFTCovXG4gIGFwcC52aWV3TW9kZWwgPSB7XG4gICAgLy9TZWxlY3RlZCBwbGFjZVxuICAgIHBsYWNlRGV0YWlsczoga28ub2JzZXJ2YWJsZSgpLFxuICAgIGlzUGxhY2VEZXRhaWxzVmlzaWJsZToga28ub2JzZXJ2YWJsZShmYWxzZSksXG4gICAgaGlkZVBsYWNlRGV0YWlsczogKCkgPT4geyBhcHAudmlld01vZGVsLmlzUGxhY2VEZXRhaWxzVmlzaWJsZShmYWxzZSkgfSxcblxuICAgIC8vIGVycm9yIG1lc3NhZ2VcbiAgICBpc0ZhaWx1cmVNb2RhbFZpc2libGU6IGtvLm9ic2VydmFibGUoZmFsc2UpLFxuICAgIGhpZGVGYWlsdXJlTW9kYWw6ICgpID0+IHsgYXBwLnZpZXdNb2RlbC5pc0ZhaWx1cmVNb2RhbFZpc2libGUoZmFsc2UpIH0sXG5cbiAgICB0ZXh0RmlsdGVyOiBrby5vYnNlcnZhYmxlKCcnKSxcblxuICAgIGZpbHRlcmVkUGxhY2VzOiBrby5wdXJlQ29tcHV0ZWQoKCkgPT4ge1xuICAgICAgbGV0IGZpbHRlcmVkUGxhY2VzO1xuICAgICAgbGV0IHRleHQgPSBhcHAudmlld01vZGVsLnRleHRGaWx0ZXIoKS50cmltKCkudG9Mb3dlckNhc2UoKSxcbiAgICAgICAgcGxhY2VzID0gYXBwLm1vZGVsLnBsYWNlcygpO1xuICAgICAgaWYgKHRleHQpIHtcbiAgICAgICAgZmlsdGVyZWRQbGFjZXMgPSBwbGFjZXMuZmlsdGVyKHBsYWNlID0+IHBsYWNlLm5hbWUudG9Mb3dlckNhc2UoKS5pbmRleE9mKHRleHQpICE9PSAtMSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBmaWx0ZXJlZFBsYWNlcyA9IHBsYWNlczsgLy8gc2hvdyBhbGwgaWYgc2VhcmNoIGZpZWxkIGlzIGVtcHR5XG4gICAgICB9XG5cbiAgICAgIGZpbHRlck1hcmtlcnMoZmlsdGVyZWRQbGFjZXMpO1xuXG4gICAgICByZXR1cm4gZmlsdGVyZWRQbGFjZXM7XG4gICAgfSksXG5cbiAgICBpc1BsYWNlc05vdExvYWRlZDoga28ucHVyZUNvbXB1dGVkKCgpID0+ICFhcHAubW9kZWwucGxhY2VzKCkubGVuZ3RoKSxcblxuICAgIC8vIHNob3cgc3Bpbm5lcj9cbiAgICBpc0xvYWRpbmc6IGtvLm9ic2VydmFibGUoZmFsc2UpLFxuXG4gICAgaXNab29tZWRPdXQ6IGtvLm9ic2VydmFibGUoZmFsc2UpLFxuXG4gICAgb25DbGlja1BsYWNlOiBhcHAuY29udHJvbGxlci5vbkNsaWNrUGxhY2VcbiAgfTtcblxuICAvKipcbiAgICogIGNyZWF0ZSBhIG1hcCwgYWRkIG1hcCBsaXN0ZW5lclxuICAgKi9cbiAgZnVuY3Rpb24gaW5pdEFwcCgpIHtcbiAgICBrby5hcHBseUJpbmRpbmdzKGFwcC52aWV3TW9kZWwpO1xuICAgIGxhc3RRdWVyeUxvY2F0aW9uID0gbmV3IGdvb2dsZS5tYXBzLkxhdExuZyh7bGF0OiAwLCBsbmc6IDB9KTtcblxuICAgIC8vIGluaXQgZ29vZ2xlIG1hcFxuICAgIGNvbnN0IEdPT0dMRV9NQVBfT1BUSU9OUyA9IHtcbiAgICAgIHpvb206IDE2LFxuICAgICAgY2VudGVyOiBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKDM3Ljc3MDM3MDYsIC0xMjIuMzg3MTIyNiksXG4gICAgICBtYXBUeXBlSWQ6IGdvb2dsZS5tYXBzLk1hcFR5cGVJZC5ST0FETUFQLFxuICAgICAgbWFwVHlwZUNvbnRyb2w6IGZhbHNlLFxuICAgICAgc3RyZWV0Vmlld0NvbnRyb2w6IGZhbHNlXG4gICAgfTtcbiAgIGNvbnN0IG1hcCA9IG5ldyBnb29nbGUubWFwcy5NYXAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dvb2dsZS1tYXAnKSwgR09PR0xFX01BUF9PUFRJT05TKTtcbiAgICBhcHAubW9kZWwubWFwID0gbWFwO1xuXG4gICAgLy8gVHJ5IEhUTUw1IGdlb2xvY2F0aW9uXG4gICAgaWYgKG5hdmlnYXRvci5nZW9sb2NhdGlvbikge1xuICAgICAgbmF2aWdhdG9yLmdlb2xvY2F0aW9uLmdldEN1cnJlbnRQb3NpdGlvbihmdW5jdGlvbiAocG9zaXRpb24pIHtcbiAgICAgICAgdmFyIHBvcyA9IHtcbiAgICAgICAgICBsYXQ6IHBvc2l0aW9uLmNvb3Jkcy5sYXRpdHVkZSxcbiAgICAgICAgICBsbmc6IHBvc2l0aW9uLmNvb3Jkcy5sb25naXR1ZGVcbiAgICAgICAgfTtcblxuICAgICAgICBhcHAuY29udHJvbGxlci5yZW1vdmVBbGxQbGFjZXMoKTtcbiAgICAgICAgbWFwLnNldENlbnRlcihwb3MpO1xuICAgICAgfSwgZnVuY3Rpb24gKCkge1xuICAgICAgICAvL2hhbmRsZUxvY2F0aW9uRXJyb3JcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBCcm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCBHZW9sb2NhdGlvblxuICAgIH1cblxuICAgIG1hcC5hZGRMaXN0ZW5lcignYm91bmRzX2NoYW5nZWQnLCBfLnRocm90dGxlKGFwcC5jb250cm9sbGVyLmxvYWRQbGFjZXMsIDIwMDApKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBsb2FkIHBsYWNlcyBmcm9tIDRzcXVhcmVcbiAgICovXG4gIGZ1bmN0aW9uIGxvYWRQbGFjZXMoKSB7XG4gICAgY29uc3QgbWFwID0gYXBwLm1vZGVsLm1hcDtcbiAgICBhcHAudmlld01vZGVsLmlzWm9vbWVkT3V0KG1hcC56b29tIDwgMTUpO1xuXG4gICAgLy8gZG9udCBhc2sgNHNxdWFyZSBvbiBiaWcgYXJlYXNcbiAgICBpZiAobWFwLnpvb20gPCAxNSkgcmV0dXJuO1xuXG4gICAgLy9kaXN0YW5jZSBiZXR3ZWVuIHRoaXMgcG9pbnQgYW5kIGxhc3QgcmVxdWVzdFxuICAgIGxldCBkaXN0YW5jZSA9IGdvb2dsZS5tYXBzLmdlb21ldHJ5LnNwaGVyaWNhbC5jb21wdXRlRGlzdGFuY2VCZXR3ZWVuKGxhc3RRdWVyeUxvY2F0aW9uLCBtYXAuY2VudGVyKTtcbiAgICAvLyBkb24ndCBsb2FkIG5ldyBkYXRhIGlmIHBvaW50IGlzIHRvbyBjbG9zZSB0byBwcmV2aW91cyBzZWFyY2hcbiAgICBpZiAoZGlzdGFuY2UgPCAxNTAwKSByZXR1cm47XG4gICAgbGFzdFF1ZXJ5TG9jYXRpb24gPSBtYXAuY2VudGVyO1xuICAgIGFwcC52aWV3TW9kZWwuaXNMb2FkaW5nKHRydWUpO1xuXG4gICAgLy8gbG9hZCBkYXRhIGZyb20gZm91cnNxdWFyZVxuICAgIC8vVE9ETyBpZGVhLCBjYWxjdWxhdGUgcmFkaXVzIGZyb20gbWFwIHpvb21cbiAgICBjb25zdCBGb3Vyc3F1YXJlUmVxdWVzdE9wdGlvbnMgPSB7XG4gICAgICBsbDogbWFwLmNlbnRlci5sYXQoKSArICcsJyArIG1hcC5jZW50ZXIubG5nKCksXG4gICAgICByYWRpdXM6IDIwMDAsXG4gICAgICBzZWN0aW9uOiAnZHJpbmtzJyxcbiAgICAgIGNsaWVudF9pZDogJ0U1NEJRMTFMQ1dKMTVRMEZINE1FTElUSTJDWlE1S1NKT1U1M1ROUkFSSjNISE5YTicsXG4gICAgICBjbGllbnRfc2VjcmV0OiAnVDRPMFpVUk1HMDBJR1VUVTROS1NRWjRESDBFNUxHTE1EQUUyME9KV1BYTUJEMTBZJyxcbiAgICAgIHY6IDIwMTYxMDI1XG4gICAgfTtcbiAgICAkLmdldCgnaHR0cHM6Ly9hcGkuZm91cnNxdWFyZS5jb20vdjIvdmVudWVzL2V4cGxvcmUnLCBGb3Vyc3F1YXJlUmVxdWVzdE9wdGlvbnMsIGFwcC5jb250cm9sbGVyLmFkZFBsYWNlcylcbiAgICAgIC5mYWlsKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgYXBwLnZpZXdNb2RlbC5pc0ZhaWx1cmVNb2RhbFZpc2libGUodHJ1ZSk7XG4gICAgICB9KVxuICAgICAgLmFsd2F5cyhmdW5jdGlvbiAoKSB7XG4gICAgICAgIGFwcC52aWV3TW9kZWwuaXNMb2FkaW5nKGZhbHNlKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIG1hcCBwbGFjZSBjb25zdHJ1Y3RvclxuICAgKiBAcGFyYW0gaXRlbSAtIG9uZSBwbGFjZSBmcm9tIGZvdXJzcXVhcmUgQVBJIHJlc3BvbnNlXG4gICAqIEBjb25zdHJ1Y3RvclxuICAgKi9cbiAgZnVuY3Rpb24gUGxhY2UoaXRlbSkge1xuICAgIGNvbnN0IG1hcCA9IGFwcC5tb2RlbC5tYXA7XG4gICAgY29uc3QgbGF0ID0gaXRlbS52ZW51ZS5sb2NhdGlvbi5sYXQsXG4gICAgICBsbmcgPSBpdGVtLnZlbnVlLmxvY2F0aW9uLmxuZyxcbiAgICAgIG5hbWUgPSBpdGVtLnZlbnVlLm5hbWU7XG5cbiAgICB0aGlzLnN0YXNoID0gaXRlbTtcbiAgICB0aGlzLmxvY2F0aW9uID0ge2xhdCwgbG5nfTtcbiAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgIHRoaXMuaXNTZWxlY3RlZCA9IGtvLm9ic2VydmFibGUoZmFsc2UpO1xuICAgIHRoaXMubWFya2VyID0gbmV3IGdvb2dsZS5tYXBzLk1hcmtlcih7XG4gICAgICBtYXA6IG1hcCxcbiAgICAgIHBvc2l0aW9uOiBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKGxhdCwgbG5nKSxcbiAgICAgIGljb246IEdfTUFSS0VSLFxuICAgIH0pO1xuICAgIHRoaXMubWFya2VyLmFkZExpc3RlbmVyKCdjbGljaycsIGFwcC5jb250cm9sbGVyLm9uQ2xpY2tNYXJrZXIpO1xuICB9XG5cbiAgLyoqXG4gICAqIGNoYW5nZSBtYXJrZXIgaWNvbiBvbiBwbGFjZSBzZWxlY3Rpb25cbiAgICovXG4gIFBsYWNlLnByb3RvdHlwZS5zZWxlY3QgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLm1hcmtlci5zZXRJY29uKEdfTUFSS0VSX1NFTEVDVEVEKTtcbiAgfTtcblxuICAvKipcbiAgICogYWRkIHBsYWNlcyB0byB0aGUgbWFwXG4gICAqIEBwYXJhbSByZXMgLSByZXN1bHRzIGZyb20gZm91cnNxdWFyZSByZXF1ZXN0XG4gICAqL1xuICBmdW5jdGlvbiBhZGRQbGFjZXMocmVzKSB7XG4gICAgLy9hcHAuY29udHJvbGxlci5yZW1vdmVBbGxQbGFjZXMoKTtcblxuICAgIHJlcy5yZXNwb25zZS5ncm91cHNbMF0uaXRlbXMuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkge1xuICAgICAgaWYgKGFwcC5tb2RlbC5wbGFjZXNIYXNoLmhhcyhpdGVtLnZlbnVlLmlkKSkgcmV0dXJuOyAvLyBkb24ndCBhbGxvdyB0byBkb3VibGUgaXRlbXMgb24gdGhlIG1hcFxuXG4gICAgICBjb25zdCBwbGFjZSA9IG5ldyBQbGFjZShpdGVtKTtcbiAgICAgIGFwcC5tb2RlbC5wbGFjZXMucHVzaChwbGFjZSk7XG4gICAgICBhcHAubW9kZWwucGxhY2VzSGFzaC5zZXQoaXRlbS52ZW51ZS5pZCwgcGxhY2UpO1xuICAgICAgYXBwLm1vZGVsLm1hcmtlcnMuc2V0KHBsYWNlLm1hcmtlciwgcGxhY2UpO1xuXG4gICAgfSk7XG5cbiAgICAvLyBub3QgbW9yZSB0aGFuIDE1MCBtYXJrZXJzIG9uIHRoZSBtYXBcbiAgICBsZXQgbGVuZ3RoID0gYXBwLm1vZGVsLnBsYWNlcygpLmxlbmd0aDtcbiAgICBpZiAobGVuZ3RoID4gMTUwKSBhcHAuY29udHJvbGxlci5yZW1vdmVQbGFjZXNGcm9tU3RhcnQobGVuZ3RoIC0gMTUwKTtcblxuICAgIGFwcC52aWV3TW9kZWwuaXNMb2FkaW5nKGZhbHNlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiByZW1vdmUgTiBwbGFjZXMgZm9ybSB0aGUgYmVnaW5uaW5nIG9mIHRoYSBwbGFjZXMgYXJyYXlcbiAgICogQHBhcmFtIE5cbiAgICovXG4gIGZ1bmN0aW9uIHJlbW92ZVBsYWNlc0Zyb21TdGFydChOKSB7XG4gICAgbGV0IHBsYWNlO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgTjsgaSsrKSB7XG4gICAgICBwbGFjZSA9IGFwcC5tb2RlbC5wbGFjZXMuc2hpZnQoKTtcbiAgICAgIHBsYWNlLm1hcmtlci5zZXRNYXAobnVsbCk7XG4gICAgICBhcHAubW9kZWwucGxhY2VzSGFzaC5kZWxldGUocGxhY2Uuc3Rhc2gudmVudWUuaWQpO1xuICAgICAgaWYgKGFwcC52aWV3TW9kZWwucGxhY2VEZXRhaWxzKCkgPT09IHBsYWNlKSBhcHAudmlld01vZGVsLnBsYWNlRGV0YWlscyhudWxsKTtcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiByZW1vdmVBbGxQbGFjZXMoKSB7XG4gICAgbGV0IE4gPSBhcHAubW9kZWwucGxhY2VzKCkubGVuZ3RoO1xuICAgIGFwcC5jb250cm9sbGVyLnJlbW92ZVBsYWNlc0Zyb21TdGFydChOKTtcbiAgfVxuXG4gIC8qKlxuICAgKiB1c2VyIGNsaWNrcyBvbiBhIG1hcCBtYXJrZXJcbiAgICovXG4gIGZ1bmN0aW9uIG9uQ2xpY2tNYXJrZXIoKSB7XG4gICAgY29uc3QgcGxhY2UgPSBhcHAubW9kZWwubWFya2Vycy5nZXQodGhpcyk7XG4gICAgb25DbGlja1BsYWNlKHBsYWNlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiB1c2VyIGNsaWNrcyBvbiBhIHBsYWNlIGluIHRoZSBtZW51XG4gICAqL1xuICBmdW5jdGlvbiBvbkNsaWNrUGxhY2UocGxhY2UpIHtcbiAgICBjb25zdCBvbGRTZWxlY3RlZCA9IGFwcC52aWV3TW9kZWwucGxhY2VEZXRhaWxzKCk7XG4gICAgaWYgKG9sZFNlbGVjdGVkID09PSBwbGFjZSkgcmV0dXJuO1xuXG4gICAgaWYob2xkU2VsZWN0ZWQpIHtcbiAgICAgIG9sZFNlbGVjdGVkLmlzU2VsZWN0ZWQoZmFsc2UpO1xuICAgICAgb2xkU2VsZWN0ZWQubWFya2VyLnNldEljb24oR19NQVJLRVIpO1xuICAgIH1cblxuICAgIC8vYWRkIHBsYWNlIHRvIHNlbGVjdGVkIGFuZCBzaG93IHBsYWNlIGRldGFpbHMgbW9kYWwgd2luZG93XG4gICAgcGxhY2UuaXNTZWxlY3RlZCh0cnVlKTtcbiAgICBhcHAudmlld01vZGVsLnBsYWNlRGV0YWlscyhwbGFjZSk7XG4gICAgYXBwLnZpZXdNb2RlbC5pc1BsYWNlRGV0YWlsc1Zpc2libGUodHJ1ZSk7XG5cbiAgICAvLyBjaGFuZ2UgbWFya2VyIGljb24gYW5kIG1vdmUgbWFwIHRvIHRoaXMgbWFya2VyXG4gICAgcGxhY2Uuc2VsZWN0KCk7XG4gICAgYXBwLm1vZGVsLm1hcC5wYW5UbyhwbGFjZS5sb2NhdGlvbik7XG5cbiAgICAvLyBoaWRlIHNpZGUgbWVudSBvbiBzbWFsbCBzY3JlZW5zIGFmdGVyIGNsaWNrXG4gICAgaWYgKHdpbmRvdy5tYXRjaE1lZGlhKCcobWF4LXdpZHRoOiA0MjZweCknKS5tYXRjaGVzKSB7XG4gICAgICAkKCcubWRsLWxheW91dF9fZHJhd2VyJykucmVtb3ZlQ2xhc3MoJ2lzLXZpc2libGUnKTtcbiAgICAgICQoJy5tZGwtbGF5b3V0X19vYmZ1c2NhdG9yJykucmVtb3ZlQ2xhc3MoJ2lzLXZpc2libGUnKTtcbiAgICB9XG4gIH07XG5cblxuICBmdW5jdGlvbiBmaWx0ZXJNYXJrZXJzKGZpbHRlcmVkUGxhY2VzKSB7XG4gICAgY29uc3QgcGxhY2VzID0gYXBwLm1vZGVsLnBsYWNlcygpO1xuICAgIC8vaGlkZSBhbGxcbiAgICBwbGFjZXMuZm9yRWFjaCgocGxhY2UpID0+IHBsYWNlLm1hcmtlci5zZXRNYXAobnVsbCkpO1xuICAgIC8vc2hvdyBmaWx0ZXJlZFxuICAgIGZpbHRlcmVkUGxhY2VzLmZvckVhY2goKHBsYWNlKSA9PiBwbGFjZS5tYXJrZXIuc2V0TWFwKGFwcC5tb2RlbC5tYXApKTtcbiAgfVxuXG4gIC8vIGV4cHJlc3Mgc29tZSBnbG9iYWxzXG4gIHdpbmRvdy5pbml0QXBwID0gYXBwLmNvbnRyb2xsZXIuaW5pdEFwcDtcbiAgd2luZG93Lmdvb2dsZUVycm9yID0gYXBwLmNvbnRyb2xsZXIuZ29vZ2xlRXJyb3I7XG5cbn0pKCk7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=\n","/* eslint-env browser */\n(function () {\n  'use strict';\n\n  const app = {};\n  let lastQueryLocation;\n\n  // google map markers\n  const G_MARKER = {\n    path: 'M0-48c-9.8 0-17.7 7.8-17.7 17.4 0 15.5 17.7 30.6 17.7 30.6s17.7-15.4 17.7-30.6c0-9.6-7.9-17.4-17.7-17.4z',\n    fillColor: '#607d8b',\n    fillOpacity: 0.7,\n    scale: 0.7,\n    strokeColor: '#607d8b',\n    strokeWeight: 3\n  };\n  const G_MARKER_SELECTED = {\n    path: 'M0-48c-9.8 0-17.7 7.8-17.7 17.4 0 15.5 17.7 30.6 17.7 30.6s17.7-15.4 17.7-30.6c0-9.6-7.9-17.4-17.7-17.4z',\n    fillColor: '#009688',\n    fillOpacity: 0.8,\n    scale: 0.8,\n    strokeColor: '#009688',\n    strokeWeight: 3\n  };\n\n  /* CONTROLLER */\n  app.controller = {\n    initApp: initApp,\n    loadPlaces: loadPlaces,           // load places from Foursquare\n\n    onClickPlace: onClickPlace,      // handle sidebar clicks\n    onClickMarker: onClickMarker,      // handle map clicks\n\n    addPlaces: addPlaces,\n    removePlacesFromStart: removePlacesFromStart,\n    removeAllPlaces: removeAllPlaces,\n\n    googleError() {\n      $('#failure-modal-google').addClass('is-visible');\n    }\n  };\n\n  /* MODEL */\n  app.model = {\n    map: null,                      // google map object\n\n    places: ko.observableArray([]).extend({rateLimit: 100}), // main places storage\n    placesHash: new Map(),          // helps to search place from foursquare place id\n    markers: new WeakMap()          // helps to search place from google marker\n  };\n\n  /* VIEW MODEL*/\n  app.viewModel = {\n    //Selected place\n    placeDetails: ko.observable(),\n    isPlaceDetailsVisible: ko.observable(false),\n    hidePlaceDetails: () => { app.viewModel.isPlaceDetailsVisible(false) },\n\n    // error message\n    isFailureModalVisible: ko.observable(false),\n    hideFailureModal: () => { app.viewModel.isFailureModalVisible(false) },\n\n    textFilter: ko.observable(''),\n\n    filteredPlaces: ko.pureComputed(() => {\n      let filteredPlaces;\n      let text = app.viewModel.textFilter().trim().toLowerCase(),\n        places = app.model.places();\n      if (text) {\n        filteredPlaces = places.filter(place => place.name.toLowerCase().indexOf(text) !== -1);\n      } else {\n        filteredPlaces = places; // show all if search field is empty\n      }\n\n      filterMarkers(filteredPlaces);\n\n      return filteredPlaces;\n    }),\n\n    isPlacesNotLoaded: ko.pureComputed(() => !app.model.places().length),\n\n    // show spinner?\n    isLoading: ko.observable(false),\n\n    isZoomedOut: ko.observable(false),\n\n    onClickPlace: app.controller.onClickPlace\n  };\n\n  /**\n   *  create a map, add map listener\n   */\n  function initApp() {\n    ko.applyBindings(app.viewModel);\n    lastQueryLocation = new google.maps.LatLng({lat: 0, lng: 0});\n\n    // init google map\n    const GOOGLE_MAP_OPTIONS = {\n      zoom: 16,\n      center: new google.maps.LatLng(37.7703706, -122.3871226),\n      mapTypeId: google.maps.MapTypeId.ROADMAP,\n      mapTypeControl: false,\n      streetViewControl: false\n    };\n   const map = new google.maps.Map(document.getElementById('google-map'), GOOGLE_MAP_OPTIONS);\n    app.model.map = map;\n\n    // Try HTML5 geolocation\n    if (navigator.geolocation) {\n      navigator.geolocation.getCurrentPosition(function (position) {\n        var pos = {\n          lat: position.coords.latitude,\n          lng: position.coords.longitude\n        };\n\n        app.controller.removeAllPlaces();\n        map.setCenter(pos);\n      }, function () {\n        //handleLocationError\n      });\n    } else {\n      // Browser doesn't support Geolocation\n    }\n\n    map.addListener('bounds_changed', _.throttle(app.controller.loadPlaces, 2000));\n  }\n\n  /**\n   * load places from 4square\n   */\n  function loadPlaces() {\n    const map = app.model.map;\n    app.viewModel.isZoomedOut(map.zoom < 15);\n\n    // dont ask 4square on big areas\n    if (map.zoom < 15) return;\n\n    //distance between this point and last request\n    let distance = google.maps.geometry.spherical.computeDistanceBetween(lastQueryLocation, map.center);\n    // don't load new data if point is too close to previous search\n    if (distance < 1500) return;\n    lastQueryLocation = map.center;\n    app.viewModel.isLoading(true);\n\n    // load data from foursquare\n    //TODO idea, calculate radius from map zoom\n    const FoursquareRequestOptions = {\n      ll: map.center.lat() + ',' + map.center.lng(),\n      radius: 2000,\n      section: 'drinks',\n      client_id: 'E54BQ11LCWJ15Q0FH4MELITI2CZQ5KSJOU53TNRARJ3HHNXN',\n      client_secret: 'T4O0ZURMG00IGUTU4NKSQZ4DH0E5LGLMDAE20OJWPXMBD10Y',\n      v: 20161025\n    };\n    $.get('https://api.foursquare.com/v2/venues/explore', FoursquareRequestOptions, app.controller.addPlaces)\n      .fail(function () {\n        app.viewModel.isFailureModalVisible(true);\n      })\n      .always(function () {\n        app.viewModel.isLoading(false);\n      });\n  }\n\n  /**\n   * map place constructor\n   * @param item - one place from foursquare API response\n   * @constructor\n   */\n  function Place(item) {\n    const map = app.model.map;\n    const lat = item.venue.location.lat,\n      lng = item.venue.location.lng,\n      name = item.venue.name;\n\n    this.stash = item;\n    this.location = {lat, lng};\n    this.name = name;\n    this.isSelected = ko.observable(false);\n    this.marker = new google.maps.Marker({\n      map: map,\n      position: new google.maps.LatLng(lat, lng),\n      icon: G_MARKER,\n    });\n    this.marker.addListener('click', app.controller.onClickMarker);\n  }\n\n  /**\n   * change marker icon on place selection\n   */\n  Place.prototype.select = function() {\n    this.marker.setIcon(G_MARKER_SELECTED);\n  };\n\n  /**\n   * add places to the map\n   * @param res - results from foursquare request\n   */\n  function addPlaces(res) {\n    //app.controller.removeAllPlaces();\n\n    res.response.groups[0].items.forEach(function (item) {\n      if (app.model.placesHash.has(item.venue.id)) return; // don't allow to double items on the map\n\n      const place = new Place(item);\n      app.model.places.push(place);\n      app.model.placesHash.set(item.venue.id, place);\n      app.model.markers.set(place.marker, place);\n\n    });\n\n    // not more than 150 markers on the map\n    let length = app.model.places().length;\n    if (length > 150) app.controller.removePlacesFromStart(length - 150);\n\n    app.viewModel.isLoading(false);\n  }\n\n  /**\n   * remove N places form the beginning of tha places array\n   * @param N\n   */\n  function removePlacesFromStart(N) {\n    let place;\n    for (let i = 0; i < N; i++) {\n      place = app.model.places.shift();\n      place.marker.setMap(null);\n      app.model.placesHash.delete(place.stash.venue.id);\n      if (app.viewModel.placeDetails() === place) app.viewModel.placeDetails(null);\n    }\n  }\n\n  function removeAllPlaces() {\n    let N = app.model.places().length;\n    app.controller.removePlacesFromStart(N);\n  }\n\n  /**\n   * user clicks on a map marker\n   */\n  function onClickMarker() {\n    const place = app.model.markers.get(this);\n    onClickPlace(place);\n  }\n\n  /**\n   * user clicks on a place in the menu\n   */\n  function onClickPlace(place) {\n    const oldSelected = app.viewModel.placeDetails();\n    if (oldSelected === place) return;\n\n    if(oldSelected) {\n      oldSelected.isSelected(false);\n      oldSelected.marker.setIcon(G_MARKER);\n    }\n\n    //add place to selected and show place details modal window\n    place.isSelected(true);\n    app.viewModel.placeDetails(place);\n    app.viewModel.isPlaceDetailsVisible(true);\n\n    // change marker icon and move map to this marker\n    place.select();\n    app.model.map.panTo(place.location);\n\n    // hide side menu on small screens after click\n    if (window.matchMedia('(max-width: 426px)').matches) {\n      $('.mdl-layout__drawer').removeClass('is-visible');\n      $('.mdl-layout__obfuscator').removeClass('is-visible');\n    }\n  };\n\n\n  function filterMarkers(filteredPlaces) {\n    const places = app.model.places();\n    //hide all\n    places.forEach((place) => place.marker.setMap(null));\n    //show filtered\n    filteredPlaces.forEach((place) => place.marker.setMap(app.model.map));\n  }\n\n  // express some globals\n  window.initApp = app.controller.initApp;\n  window.googleError = app.controller.googleError;\n\n})();\n"],"sourceRoot":"/source/"}