{"version":3,"sources":["main.js","/source/main.js"],"names":["initApp","map","google","maps","Map","document","getElementById","GOOGLE_MAP_OPTIONS","app","model","navigator","geolocation","getCurrentPosition","position","pos","lat","coords","latitude","lng","longitude","controller","removeAllPlaces","setCenter","addListener","_","throttle","loadPlaces","viewModel","isZoomedOut","zoom","distance","geometry","spherical","computeDistanceBetween","lastQueryLocation","center","isLoading","FoursquareRequestOptions","ll","radius","section","client_id","client_secret","v","$","get","addPlaces","fail","isFailureModalVisible","always","Place","item","venue","location","name","this","stash","isSelected","ko","observable","marker","Marker","LatLng","icon","G_MARKER","onClickMarker","res","response","groups","items","forEach","placesHash","has","id","place","places","push","set","markers","length","removePlacesFromStart","N","i","shift","setMap","placeDetails","onClickPlace","oldSelected","setIcon","isPlaceDetailsVisible","G_MARKER_SELECTED","panTo","window","matchMedia","matches","removeClass","mapTypeId","MapTypeId","ROADMAP","mapTypeControl","streetViewControl","path","fillColor","fillOpacity","scale","strokeColor","strokeWeight","observableArray","extend","rateLimit","WeakMap","hidePlaceDetails","hideFailureModal","textFilter","filteredPlaces","pureComputed","text","trim","toLowerCase","filter","indexOf","isPlacesNotLoaded","applyBindings"],"mappings":"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","file":"main.js","sourcesContent":["'use strict'; /* eslint-env browser */\n(function () {\n  'use strict';\n\n  var app = {};\n  var lastQueryLocation = new google.maps.LatLng({ lat: 0, lng: 0 });\n\n  /* CONSTANTS */\n  var GOOGLE_MAP_OPTIONS = {\n    zoom: 16,\n    center: new google.maps.LatLng(37.7703706, -122.3871226),\n    mapTypeId: google.maps.MapTypeId.ROADMAP,\n    mapTypeControl: false,\n    streetViewControl: false };\n\n\n  // google map markers\n  var G_MARKER = {\n    path: 'M0-48c-9.8 0-17.7 7.8-17.7 17.4 0 15.5 17.7 30.6 17.7 30.6s17.7-15.4 17.7-30.6c0-9.6-7.9-17.4-17.7-17.4z',\n    fillColor: '#607d8b',\n    fillOpacity: 0.7,\n    scale: 0.7,\n    strokeColor: '#607d8b',\n    strokeWeight: 3 };\n\n  var G_MARKER_SELECTED = {\n    path: 'M0-48c-9.8 0-17.7 7.8-17.7 17.4 0 15.5 17.7 30.6 17.7 30.6s17.7-15.4 17.7-30.6c0-9.6-7.9-17.4-17.7-17.4z',\n    fillColor: '#009688',\n    fillOpacity: 0.8,\n    scale: 0.8,\n    strokeColor: '#009688',\n    strokeWeight: 3 };\n\n\n\n  /* CONTROLLER */\n  app.controller = {\n    initApp: initApp,\n    loadPlaces: loadPlaces, // load places from Foursquare\n\n    onClickPlace: onClickPlace, // handle sidebar clicks\n    onClickMarker: onClickMarker, // handle map clicks\n\n    addPlaces: addPlaces,\n    removePlacesFromStart: removePlacesFromStart,\n    removeAllPlaces: removeAllPlaces };\n\n\n  /* MODEL */\n  app.model = {\n    map: null, // google map object\n\n    places: ko.observableArray([]).extend({ rateLimit: 100 }), // main places storage\n    placesHash: new Map(), // helps to search place from foursquare place id\n    markers: new WeakMap() // helps to search place from google marker\n  };\n\n  /* VIEW MODEL*/\n  app.viewModel = {\n    //Selected place\n    placeDetails: ko.observable(),\n    isPlaceDetailsVisible: ko.observable(false),\n    hidePlaceDetails: function hidePlaceDetails() {app.viewModel.isPlaceDetailsVisible(false);},\n\n    // error message\n    isFailureModalVisible: ko.observable(false),\n    hideFailureModal: function hideFailureModal() {app.viewModel.isFailureModalVisible(false);},\n\n    textFilter: ko.observable(''),\n\n    filteredPlaces: ko.pureComputed(function () {\n      var text = app.viewModel.textFilter().trim().toLowerCase(),\n      places = app.model.places();\n      if (!text) return places;\n\n      return _.filter(places, function (place) {return place.name.toLowerCase().indexOf(text) !== -1;});\n    }),\n\n    isPlacesNotLoaded: ko.pureComputed(function () {\n      var places = app.model.places();\n      return places.length === 0;\n    }),\n\n    // show spinner?\n    isLoading: ko.observable(false),\n\n    isZoomedOut: ko.observable(false),\n\n    onClickPlace: app.controller.onClickPlace };\n\n\n  /**\n                                                  *  create a map, add map listener\n                                                  */\n  function initApp() {\n    // init google map\n\n    var map = new google.maps.Map(document.getElementById('google-map'), GOOGLE_MAP_OPTIONS);\n    app.model.map = map;\n\n    // Try HTML5 geolocation\n    if (navigator.geolocation) {\n      navigator.geolocation.getCurrentPosition(function (position) {\n        var pos = {\n          lat: position.coords.latitude,\n          lng: position.coords.longitude };\n\n\n        app.controller.removeAllPlaces();\n        map.setCenter(pos);\n      }, function () {\n        //handleLocationError\n      });\n    } else {\n        // Browser doesn't support Geolocation\n      }\n\n    map.addListener('bounds_changed', _.throttle(app.controller.loadPlaces, 2000));\n  }\n\n  /**\n     * load places from 4square\n     */\n  function loadPlaces() {\n    var map = app.model.map;\n    app.viewModel.isZoomedOut(map.zoom < 15);\n\n    // dont ask 4square on big areas\n    if (map.zoom < 15) return;\n\n    //distance between this point and last request\n    var distance = google.maps.geometry.spherical.computeDistanceBetween(lastQueryLocation, map.center);\n    // don't load new data if point is too close to previous search\n    if (distance < 1500) return;\n    lastQueryLocation = map.center;\n    app.viewModel.isLoading(true);\n\n    // load data from foursquare\n    //TODO idea, calculate radius from map zoom\n    var FoursquareRequestOptions = {\n      ll: map.center.lat() + ',' + map.center.lng(),\n      radius: 2000,\n      section: 'drinks',\n      client_id: 'E54BQ11LCWJ15Q0FH4MELITI2CZQ5KSJOU53TNRARJ3HHNXN',\n      client_secret: 'T4O0ZURMG00IGUTU4NKSQZ4DH0E5LGLMDAE20OJWPXMBD10Y',\n      v: 20160909 };\n\n    $.get('https://api.foursquare.com/v2/venues/explore', FoursquareRequestOptions, app.controller.addPlaces).\n    fail(function () {\n      app.viewModel.isFailureModalVisible(true);\n    }).\n    always(function () {\n      app.viewModel.isLoading(false);\n    });\n  }\n\n  /**\n     * map place constructor\n     * @param item - one place from foursquare API response\n     * @constructor\n     */\n  function Place(item) {\n    var map = app.model.map;\n    var lat = item.venue.location.lat,\n    lng = item.venue.location.lng,\n    name = item.venue.name;\n\n    this.stash = item;\n    this.location = { lat: lat, lng: lng };\n    this.name = name;\n    this.isSelected = ko.observable(false);\n    this.marker = new google.maps.Marker({\n      map: map,\n      position: new google.maps.LatLng(lat, lng),\n      icon: G_MARKER });\n\n    this.marker.addListener('click', app.controller.onClickMarker);\n  }\n\n  /**\n     * add places to the map\n     * @param res - results from foursquare request\n     */\n  function addPlaces(res) {\n    //app.controller.removeAllPlaces();\n\n    res.response.groups[0].items.forEach(function (item) {\n      if (app.model.placesHash.has(item.venue.id)) return; // don't allow to double items on the map\n\n      var place = new Place(item);\n      app.model.places.push(place);\n      app.model.placesHash.set(item.venue.id, place);\n      app.model.markers.set(place.marker, place);\n\n    });\n\n    // not more than 150 markers on the map\n    var length = app.model.places().length;\n    if (length > 150) app.controller.removePlacesFromStart(length - 150);\n\n    app.viewModel.isLoading(false);\n  }\n\n  /**\n     * remove N places form the beginning of tha places array\n     * @param N\n     */\n  function removePlacesFromStart(N) {\n    var place = void 0;\n    for (var i = 0; i < N; i++) {\n      place = app.model.places.shift();\n      place.marker.setMap(null);\n      app.model.placesHash.delete(place.stash.venue.id);\n      if (app.viewModel.placeDetails() === place) app.viewModel.placeDetails(null);\n    }\n  }\n\n  function removeAllPlaces() {\n    var N = app.model.places().length;\n    app.controller.removePlacesFromStart(N);\n  }\n\n  /**\n     * user clicks on a place in the menu\n     * @param place\n     */\n  function onClickPlace(place) {\n    var oldSelected = app.viewModel.placeDetails();\n    if (oldSelected === place) return;\n\n    if (oldSelected) {\n      oldSelected.isSelected(false);\n      oldSelected.marker.setIcon(G_MARKER);\n    }\n\n    //add place to selected and show place details modal window\n    place.isSelected(true);\n    app.viewModel.placeDetails(place);\n    app.viewModel.isPlaceDetailsVisible(true);\n\n    // change marker icon and move map to this marker\n    place.marker.setIcon(G_MARKER_SELECTED);\n    app.model.map.panTo(place.location);\n\n    // hide side menu on small screens after click\n    if (window.matchMedia('(max-width: 426px)').matches) {\n      $('.mdl-layout__drawer').removeClass('is-visible');\n      $('.mdl-layout__obfuscator').removeClass('is-visible');\n    }\n  }\n\n  /**\n     * user clicks on a map marker\n     */\n  function onClickMarker() {\n    var place = app.model.markers.get(this);\n    app.controller.onClickPlace(place);\n  }\n\n  // init app after page loading\n  $(function () {\n    ko.applyBindings(app.viewModel);\n    app.controller.initApp();\n  });\n})();\n//# sourceMappingURL=data:application/json;base64,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QTdCLENBQXlDLFlBQXpDO0FBQ0Q7QUFDRjs7QUFFRDs7O0FBR0EsV0FBUyxhQUFULEdBQXlCO0FBQ3ZCLFFBQU0sUUFBUSxJQUFJLEtBQUosQ0FBVSxPQUFWLENBQWtCLEdBQWxCLENBQXNCLElBQXRCLENBQWQ7QUFDQSxRQUFJLFVBQUosQ0FBZSxZQUFmLENBQTRCLEtBQTVCO0FBQ0Q7O0FBRUQ7QUFDQSxJQUFFLFlBQVk7QUFDWixPQUFHLGFBQUgsQ0FBaUIsSUFBSSxTQUFyQjtBQUNBLFFBQUksVUFBSixDQUFlLE9BQWY7QUFDRCxHQUhEO0FBSUQsQ0F2UUQiLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1lbnYgYnJvd3NlciAqL1xuKGZ1bmN0aW9uICgpIHtcbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIGNvbnN0IGFwcCA9IHt9O1xuICBsZXQgbGFzdFF1ZXJ5TG9jYXRpb24gPSBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKHtsYXQ6IDAsIGxuZzogMH0pO1xuXG4gIC8qIENPTlNUQU5UUyAqL1xuICBjb25zdCBHT09HTEVfTUFQX09QVElPTlMgPSB7XG4gICAgem9vbTogMTYsXG4gICAgY2VudGVyOiBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKDM3Ljc3MDM3MDYsIC0xMjIuMzg3MTIyNiksXG4gICAgbWFwVHlwZUlkOiBnb29nbGUubWFwcy5NYXBUeXBlSWQuUk9BRE1BUCxcbiAgICBtYXBUeXBlQ29udHJvbDogZmFsc2UsXG4gICAgc3RyZWV0Vmlld0NvbnRyb2w6IGZhbHNlXG4gIH07XG5cbiAgLy8gZ29vZ2xlIG1hcCBtYXJrZXJzXG4gIGNvbnN0IEdfTUFSS0VSID0ge1xuICAgIHBhdGg6ICdNMC00OGMtOS44IDAtMTcuNyA3LjgtMTcuNyAxNy40IDAgMTUuNSAxNy43IDMwLjYgMTcuNyAzMC42czE3LjctMTUuNCAxNy43LTMwLjZjMC05LjYtNy45LTE3LjQtMTcuNy0xNy40eicsXG4gICAgZmlsbENvbG9yOiAnIzYwN2Q4YicsXG4gICAgZmlsbE9wYWNpdHk6IDAuNyxcbiAgICBzY2FsZTogMC43LFxuICAgIHN0cm9rZUNvbG9yOiAnIzYwN2Q4YicsXG4gICAgc3Ryb2tlV2VpZ2h0OiAzXG4gIH07XG4gIGNvbnN0IEdfTUFSS0VSX1NFTEVDVEVEID0ge1xuICAgIHBhdGg6ICdNMC00OGMtOS44IDAtMTcuNyA3LjgtMTcuNyAxNy40IDAgMTUuNSAxNy43IDMwLjYgMTcuNyAzMC42czE3LjctMTUuNCAxNy43LTMwLjZjMC05LjYtNy45LTE3LjQtMTcuNy0xNy40eicsXG4gICAgZmlsbENvbG9yOiAnIzAwOTY4OCcsXG4gICAgZmlsbE9wYWNpdHk6IDAuOCxcbiAgICBzY2FsZTogMC44LFxuICAgIHN0cm9rZUNvbG9yOiAnIzAwOTY4OCcsXG4gICAgc3Ryb2tlV2VpZ2h0OiAzXG4gIH07XG5cblxuICAvKiBDT05UUk9MTEVSICovXG4gIGFwcC5jb250cm9sbGVyID0ge1xuICAgIGluaXRBcHA6IGluaXRBcHAsXG4gICAgbG9hZFBsYWNlczogbG9hZFBsYWNlcywgICAgICAgICAgIC8vIGxvYWQgcGxhY2VzIGZyb20gRm91cnNxdWFyZVxuXG4gICAgb25DbGlja1BsYWNlOiBvbkNsaWNrUGxhY2UsICAgICAgLy8gaGFuZGxlIHNpZGViYXIgY2xpY2tzXG4gICAgb25DbGlja01hcmtlcjogb25DbGlja01hcmtlciwgICAgICAvLyBoYW5kbGUgbWFwIGNsaWNrc1xuXG4gICAgYWRkUGxhY2VzOiBhZGRQbGFjZXMsXG4gICAgcmVtb3ZlUGxhY2VzRnJvbVN0YXJ0OiByZW1vdmVQbGFjZXNGcm9tU3RhcnQsXG4gICAgcmVtb3ZlQWxsUGxhY2VzOiByZW1vdmVBbGxQbGFjZXMsXG4gIH07XG5cbiAgLyogTU9ERUwgKi9cbiAgYXBwLm1vZGVsID0ge1xuICAgIG1hcDogbnVsbCwgICAgICAgICAgICAgICAgICAgICAgLy8gZ29vZ2xlIG1hcCBvYmplY3RcblxuICAgIHBsYWNlczoga28ub2JzZXJ2YWJsZUFycmF5KFtdKS5leHRlbmQoe3JhdGVMaW1pdDogMTAwfSksIC8vIG1haW4gcGxhY2VzIHN0b3JhZ2VcbiAgICBwbGFjZXNIYXNoOiBuZXcgTWFwKCksICAgICAgICAgIC8vIGhlbHBzIHRvIHNlYXJjaCBwbGFjZSBmcm9tIGZvdXJzcXVhcmUgcGxhY2UgaWRcbiAgICBtYXJrZXJzOiBuZXcgV2Vha01hcCgpICAgICAgICAgIC8vIGhlbHBzIHRvIHNlYXJjaCBwbGFjZSBmcm9tIGdvb2dsZSBtYXJrZXJcbiAgfTtcblxuICAvKiBWSUVXIE1PREVMKi9cbiAgYXBwLnZpZXdNb2RlbCA9IHtcbiAgICAvL1NlbGVjdGVkIHBsYWNlXG4gICAgcGxhY2VEZXRhaWxzOiBrby5vYnNlcnZhYmxlKCksXG4gICAgaXNQbGFjZURldGFpbHNWaXNpYmxlOiBrby5vYnNlcnZhYmxlKGZhbHNlKSxcbiAgICBoaWRlUGxhY2VEZXRhaWxzOiAoKSA9PiB7IGFwcC52aWV3TW9kZWwuaXNQbGFjZURldGFpbHNWaXNpYmxlKGZhbHNlKSB9LFxuXG4gICAgLy8gZXJyb3IgbWVzc2FnZVxuICAgIGlzRmFpbHVyZU1vZGFsVmlzaWJsZToga28ub2JzZXJ2YWJsZShmYWxzZSksXG4gICAgaGlkZUZhaWx1cmVNb2RhbDogKCkgPT4geyBhcHAudmlld01vZGVsLmlzRmFpbHVyZU1vZGFsVmlzaWJsZShmYWxzZSkgfSxcblxuICAgIHRleHRGaWx0ZXI6IGtvLm9ic2VydmFibGUoJycpLFxuXG4gICAgZmlsdGVyZWRQbGFjZXM6IGtvLnB1cmVDb21wdXRlZCgoKSA9PiB7XG4gICAgICBsZXQgdGV4dCA9IGFwcC52aWV3TW9kZWwudGV4dEZpbHRlcigpLnRyaW0oKS50b0xvd2VyQ2FzZSgpLFxuICAgICAgICBwbGFjZXMgPSBhcHAubW9kZWwucGxhY2VzKCk7XG4gICAgICBpZiAoIXRleHQpIHJldHVybiBwbGFjZXM7XG5cbiAgICAgIHJldHVybiBfLmZpbHRlcihwbGFjZXMsIHBsYWNlID0+IHBsYWNlLm5hbWUudG9Mb3dlckNhc2UoKS5pbmRleE9mKHRleHQpICE9PSAtMSk7XG4gICAgfSksXG5cbiAgICBpc1BsYWNlc05vdExvYWRlZDoga28ucHVyZUNvbXB1dGVkKCgpID0+IHtcbiAgICAgIGxldCBwbGFjZXMgPSBhcHAubW9kZWwucGxhY2VzKCk7XG4gICAgICByZXR1cm4gcGxhY2VzLmxlbmd0aCA9PT0gMDtcbiAgICB9KSxcblxuICAgIC8vIHNob3cgc3Bpbm5lcj9cbiAgICBpc0xvYWRpbmc6IGtvLm9ic2VydmFibGUoZmFsc2UpLFxuICAgIFxuICAgIGlzWm9vbWVkT3V0OiBrby5vYnNlcnZhYmxlKGZhbHNlKSxcblxuICAgIG9uQ2xpY2tQbGFjZTogYXBwLmNvbnRyb2xsZXIub25DbGlja1BsYWNlXG4gIH07XG5cbiAgLyoqXG4gICAqICBjcmVhdGUgYSBtYXAsIGFkZCBtYXAgbGlzdGVuZXJcbiAgICovXG4gIGZ1bmN0aW9uIGluaXRBcHAoKSB7XG4gICAgLy8gaW5pdCBnb29nbGUgbWFwXG5cbiAgICBjb25zdCBtYXAgPSBuZXcgZ29vZ2xlLm1hcHMuTWFwKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnb29nbGUtbWFwJyksIEdPT0dMRV9NQVBfT1BUSU9OUyk7XG4gICAgYXBwLm1vZGVsLm1hcCA9IG1hcDtcblxuICAgIC8vIFRyeSBIVE1MNSBnZW9sb2NhdGlvblxuICAgIGlmIChuYXZpZ2F0b3IuZ2VvbG9jYXRpb24pIHtcbiAgICAgIG5hdmlnYXRvci5nZW9sb2NhdGlvbi5nZXRDdXJyZW50UG9zaXRpb24oZnVuY3Rpb24gKHBvc2l0aW9uKSB7XG4gICAgICAgIHZhciBwb3MgPSB7XG4gICAgICAgICAgbGF0OiBwb3NpdGlvbi5jb29yZHMubGF0aXR1ZGUsXG4gICAgICAgICAgbG5nOiBwb3NpdGlvbi5jb29yZHMubG9uZ2l0dWRlXG4gICAgICAgIH07XG5cbiAgICAgICAgYXBwLmNvbnRyb2xsZXIucmVtb3ZlQWxsUGxhY2VzKCk7XG4gICAgICAgIG1hcC5zZXRDZW50ZXIocG9zKTtcbiAgICAgIH0sIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgLy9oYW5kbGVMb2NhdGlvbkVycm9yXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gQnJvd3NlciBkb2Vzbid0IHN1cHBvcnQgR2VvbG9jYXRpb25cbiAgICB9XG5cbiAgICBtYXAuYWRkTGlzdGVuZXIoJ2JvdW5kc19jaGFuZ2VkJywgXy50aHJvdHRsZShhcHAuY29udHJvbGxlci5sb2FkUGxhY2VzLCAyMDAwKSk7XG4gIH1cblxuICAvKipcbiAgICogbG9hZCBwbGFjZXMgZnJvbSA0c3F1YXJlXG4gICAqL1xuICBmdW5jdGlvbiBsb2FkUGxhY2VzKCkge1xuICAgIGNvbnN0IG1hcCA9IGFwcC5tb2RlbC5tYXA7XG4gICAgYXBwLnZpZXdNb2RlbC5pc1pvb21lZE91dChtYXAuem9vbSA8IDE1KTtcblxuICAgIC8vIGRvbnQgYXNrIDRzcXVhcmUgb24gYmlnIGFyZWFzXG4gICAgaWYgKG1hcC56b29tIDwgMTUpIHJldHVybjtcblxuICAgIC8vZGlzdGFuY2UgYmV0d2VlbiB0aGlzIHBvaW50IGFuZCBsYXN0IHJlcXVlc3RcbiAgICBsZXQgZGlzdGFuY2UgPSBnb29nbGUubWFwcy5nZW9tZXRyeS5zcGhlcmljYWwuY29tcHV0ZURpc3RhbmNlQmV0d2VlbihsYXN0UXVlcnlMb2NhdGlvbiwgbWFwLmNlbnRlcik7XG4gICAgLy8gZG9uJ3QgbG9hZCBuZXcgZGF0YSBpZiBwb2ludCBpcyB0b28gY2xvc2UgdG8gcHJldmlvdXMgc2VhcmNoXG4gICAgaWYgKGRpc3RhbmNlIDwgMTUwMCkgcmV0dXJuO1xuICAgIGxhc3RRdWVyeUxvY2F0aW9uID0gbWFwLmNlbnRlcjtcbiAgICBhcHAudmlld01vZGVsLmlzTG9hZGluZyh0cnVlKTtcblxuICAgIC8vIGxvYWQgZGF0YSBmcm9tIGZvdXJzcXVhcmVcbiAgICAvL1RPRE8gaWRlYSwgY2FsY3VsYXRlIHJhZGl1cyBmcm9tIG1hcCB6b29tXG4gICAgY29uc3QgRm91cnNxdWFyZVJlcXVlc3RPcHRpb25zID0ge1xuICAgICAgbGw6IG1hcC5jZW50ZXIubGF0KCkgKyAnLCcgKyBtYXAuY2VudGVyLmxuZygpLFxuICAgICAgcmFkaXVzOiAyMDAwLFxuICAgICAgc2VjdGlvbjogJ2RyaW5rcycsXG4gICAgICBjbGllbnRfaWQ6ICdFNTRCUTExTENXSjE1UTBGSDRNRUxJVEkyQ1pRNUtTSk9VNTNUTlJBUkozSEhOWE4nLFxuICAgICAgY2xpZW50X3NlY3JldDogJ1Q0TzBaVVJNRzAwSUdVVFU0TktTUVo0REgwRTVMR0xNREFFMjBPSldQWE1CRDEwWScsXG4gICAgICB2OiAyMDE2MDkwOVxuICAgIH07XG4gICAgJC5nZXQoJ2h0dHBzOi8vYXBpLmZvdXJzcXVhcmUuY29tL3YyL3ZlbnVlcy9leHBsb3JlJywgRm91cnNxdWFyZVJlcXVlc3RPcHRpb25zLCBhcHAuY29udHJvbGxlci5hZGRQbGFjZXMpXG4gICAgICAuZmFpbChmdW5jdGlvbiAoKSB7XG4gICAgICAgIGFwcC52aWV3TW9kZWwuaXNGYWlsdXJlTW9kYWxWaXNpYmxlKHRydWUpO1xuICAgICAgfSlcbiAgICAgIC5hbHdheXMoZnVuY3Rpb24gKCkge1xuICAgICAgICBhcHAudmlld01vZGVsLmlzTG9hZGluZyhmYWxzZSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBtYXAgcGxhY2UgY29uc3RydWN0b3JcbiAgICogQHBhcmFtIGl0ZW0gLSBvbmUgcGxhY2UgZnJvbSBmb3Vyc3F1YXJlIEFQSSByZXNwb25zZVxuICAgKiBAY29uc3RydWN0b3JcbiAgICovXG4gIGZ1bmN0aW9uIFBsYWNlKGl0ZW0pIHtcbiAgICBjb25zdCBtYXAgPSBhcHAubW9kZWwubWFwO1xuICAgIGNvbnN0IGxhdCA9IGl0ZW0udmVudWUubG9jYXRpb24ubGF0LFxuICAgICAgbG5nID0gaXRlbS52ZW51ZS5sb2NhdGlvbi5sbmcsXG4gICAgICBuYW1lID0gaXRlbS52ZW51ZS5uYW1lO1xuXG4gICAgdGhpcy5zdGFzaCA9IGl0ZW07XG4gICAgdGhpcy5sb2NhdGlvbiA9IHtsYXQsIGxuZ307XG4gICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICB0aGlzLmlzU2VsZWN0ZWQgPSBrby5vYnNlcnZhYmxlKGZhbHNlKTtcbiAgICB0aGlzLm1hcmtlciA9IG5ldyBnb29nbGUubWFwcy5NYXJrZXIoe1xuICAgICAgbWFwOiBtYXAsXG4gICAgICBwb3NpdGlvbjogbmV3IGdvb2dsZS5tYXBzLkxhdExuZyhsYXQsIGxuZyksXG4gICAgICBpY29uOiBHX01BUktFUixcbiAgICB9KTtcbiAgICB0aGlzLm1hcmtlci5hZGRMaXN0ZW5lcignY2xpY2snLCBhcHAuY29udHJvbGxlci5vbkNsaWNrTWFya2VyKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBhZGQgcGxhY2VzIHRvIHRoZSBtYXBcbiAgICogQHBhcmFtIHJlcyAtIHJlc3VsdHMgZnJvbSBmb3Vyc3F1YXJlIHJlcXVlc3RcbiAgICovXG4gIGZ1bmN0aW9uIGFkZFBsYWNlcyhyZXMpIHtcbiAgICAvL2FwcC5jb250cm9sbGVyLnJlbW92ZUFsbFBsYWNlcygpO1xuXG4gICAgcmVzLnJlc3BvbnNlLmdyb3Vwc1swXS5pdGVtcy5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7XG4gICAgICBpZiAoYXBwLm1vZGVsLnBsYWNlc0hhc2guaGFzKGl0ZW0udmVudWUuaWQpKSByZXR1cm47IC8vIGRvbid0IGFsbG93IHRvIGRvdWJsZSBpdGVtcyBvbiB0aGUgbWFwXG5cbiAgICAgIGNvbnN0IHBsYWNlID0gbmV3IFBsYWNlKGl0ZW0pO1xuICAgICAgYXBwLm1vZGVsLnBsYWNlcy5wdXNoKHBsYWNlKTtcbiAgICAgIGFwcC5tb2RlbC5wbGFjZXNIYXNoLnNldChpdGVtLnZlbnVlLmlkLCBwbGFjZSk7XG4gICAgICBhcHAubW9kZWwubWFya2Vycy5zZXQocGxhY2UubWFya2VyLCBwbGFjZSk7XG5cbiAgICB9KTtcblxuICAgIC8vIG5vdCBtb3JlIHRoYW4gMTUwIG1hcmtlcnMgb24gdGhlIG1hcFxuICAgIGxldCBsZW5ndGggPSBhcHAubW9kZWwucGxhY2VzKCkubGVuZ3RoO1xuICAgIGlmIChsZW5ndGggPiAxNTApIGFwcC5jb250cm9sbGVyLnJlbW92ZVBsYWNlc0Zyb21TdGFydChsZW5ndGggLSAxNTApO1xuXG4gICAgYXBwLnZpZXdNb2RlbC5pc0xvYWRpbmcoZmFsc2UpO1xuICB9XG5cbiAgLyoqXG4gICAqIHJlbW92ZSBOIHBsYWNlcyBmb3JtIHRoZSBiZWdpbm5pbmcgb2YgdGhhIHBsYWNlcyBhcnJheVxuICAgKiBAcGFyYW0gTlxuICAgKi9cbiAgZnVuY3Rpb24gcmVtb3ZlUGxhY2VzRnJvbVN0YXJ0KE4pIHtcbiAgICBsZXQgcGxhY2U7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBOOyBpKyspIHtcbiAgICAgIHBsYWNlID0gYXBwLm1vZGVsLnBsYWNlcy5zaGlmdCgpO1xuICAgICAgcGxhY2UubWFya2VyLnNldE1hcChudWxsKTtcbiAgICAgIGFwcC5tb2RlbC5wbGFjZXNIYXNoLmRlbGV0ZShwbGFjZS5zdGFzaC52ZW51ZS5pZCk7XG4gICAgICBpZiAoYXBwLnZpZXdNb2RlbC5wbGFjZURldGFpbHMoKSA9PT0gcGxhY2UpIGFwcC52aWV3TW9kZWwucGxhY2VEZXRhaWxzKG51bGwpO1xuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIHJlbW92ZUFsbFBsYWNlcygpIHtcbiAgICBsZXQgTiA9IGFwcC5tb2RlbC5wbGFjZXMoKS5sZW5ndGg7XG4gICAgYXBwLmNvbnRyb2xsZXIucmVtb3ZlUGxhY2VzRnJvbVN0YXJ0KE4pO1xuICB9XG5cbiAgLyoqXG4gICAqIHVzZXIgY2xpY2tzIG9uIGEgcGxhY2UgaW4gdGhlIG1lbnVcbiAgICogQHBhcmFtIHBsYWNlXG4gICAqL1xuICBmdW5jdGlvbiBvbkNsaWNrUGxhY2UocGxhY2UpIHtcbiAgICBjb25zdCBvbGRTZWxlY3RlZCA9IGFwcC52aWV3TW9kZWwucGxhY2VEZXRhaWxzKCk7XG4gICAgaWYgKG9sZFNlbGVjdGVkID09PSBwbGFjZSkgcmV0dXJuO1xuXG4gICAgaWYob2xkU2VsZWN0ZWQpIHtcbiAgICAgIG9sZFNlbGVjdGVkLmlzU2VsZWN0ZWQoZmFsc2UpO1xuICAgICAgb2xkU2VsZWN0ZWQubWFya2VyLnNldEljb24oR19NQVJLRVIpO1xuICAgIH1cblxuICAgIC8vYWRkIHBsYWNlIHRvIHNlbGVjdGVkIGFuZCBzaG93IHBsYWNlIGRldGFpbHMgbW9kYWwgd2luZG93XG4gICAgcGxhY2UuaXNTZWxlY3RlZCh0cnVlKTtcbiAgICBhcHAudmlld01vZGVsLnBsYWNlRGV0YWlscyhwbGFjZSk7XG4gICAgYXBwLnZpZXdNb2RlbC5pc1BsYWNlRGV0YWlsc1Zpc2libGUodHJ1ZSk7XG5cbiAgICAvLyBjaGFuZ2UgbWFya2VyIGljb24gYW5kIG1vdmUgbWFwIHRvIHRoaXMgbWFya2VyXG4gICAgcGxhY2UubWFya2VyLnNldEljb24oR19NQVJLRVJfU0VMRUNURUQpO1xuICAgIGFwcC5tb2RlbC5tYXAucGFuVG8ocGxhY2UubG9jYXRpb24pO1xuXG4gICAgLy8gaGlkZSBzaWRlIG1lbnUgb24gc21hbGwgc2NyZWVucyBhZnRlciBjbGlja1xuICAgIGlmICh3aW5kb3cubWF0Y2hNZWRpYSgnKG1heC13aWR0aDogNDI2cHgpJykubWF0Y2hlcykge1xuICAgICAgJCgnLm1kbC1sYXlvdXRfX2RyYXdlcicpLnJlbW92ZUNsYXNzKCdpcy12aXNpYmxlJyk7XG4gICAgICAkKCcubWRsLWxheW91dF9fb2JmdXNjYXRvcicpLnJlbW92ZUNsYXNzKCdpcy12aXNpYmxlJyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIHVzZXIgY2xpY2tzIG9uIGEgbWFwIG1hcmtlclxuICAgKi9cbiAgZnVuY3Rpb24gb25DbGlja01hcmtlcigpIHtcbiAgICBjb25zdCBwbGFjZSA9IGFwcC5tb2RlbC5tYXJrZXJzLmdldCh0aGlzKTtcbiAgICBhcHAuY29udHJvbGxlci5vbkNsaWNrUGxhY2UocGxhY2UpO1xuICB9XG5cbiAgLy8gaW5pdCBhcHAgYWZ0ZXIgcGFnZSBsb2FkaW5nXG4gICQoZnVuY3Rpb24gKCkge1xuICAgIGtvLmFwcGx5QmluZGluZ3MoYXBwLnZpZXdNb2RlbCk7XG4gICAgYXBwLmNvbnRyb2xsZXIuaW5pdEFwcCgpO1xuICB9KTtcbn0pKCk7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=\n","/* eslint-env browser */\n(function () {\n  'use strict';\n\n  const app = {};\n  let lastQueryLocation = new google.maps.LatLng({lat: 0, lng: 0});\n\n  /* CONSTANTS */\n  const GOOGLE_MAP_OPTIONS = {\n    zoom: 16,\n    center: new google.maps.LatLng(37.7703706, -122.3871226),\n    mapTypeId: google.maps.MapTypeId.ROADMAP,\n    mapTypeControl: false,\n    streetViewControl: false\n  };\n\n  // google map markers\n  const G_MARKER = {\n    path: 'M0-48c-9.8 0-17.7 7.8-17.7 17.4 0 15.5 17.7 30.6 17.7 30.6s17.7-15.4 17.7-30.6c0-9.6-7.9-17.4-17.7-17.4z',\n    fillColor: '#607d8b',\n    fillOpacity: 0.7,\n    scale: 0.7,\n    strokeColor: '#607d8b',\n    strokeWeight: 3\n  };\n  const G_MARKER_SELECTED = {\n    path: 'M0-48c-9.8 0-17.7 7.8-17.7 17.4 0 15.5 17.7 30.6 17.7 30.6s17.7-15.4 17.7-30.6c0-9.6-7.9-17.4-17.7-17.4z',\n    fillColor: '#009688',\n    fillOpacity: 0.8,\n    scale: 0.8,\n    strokeColor: '#009688',\n    strokeWeight: 3\n  };\n\n\n  /* CONTROLLER */\n  app.controller = {\n    initApp: initApp,\n    loadPlaces: loadPlaces,           // load places from Foursquare\n\n    onClickPlace: onClickPlace,      // handle sidebar clicks\n    onClickMarker: onClickMarker,      // handle map clicks\n\n    addPlaces: addPlaces,\n    removePlacesFromStart: removePlacesFromStart,\n    removeAllPlaces: removeAllPlaces,\n  };\n\n  /* MODEL */\n  app.model = {\n    map: null,                      // google map object\n\n    places: ko.observableArray([]).extend({rateLimit: 100}), // main places storage\n    placesHash: new Map(),          // helps to search place from foursquare place id\n    markers: new WeakMap()          // helps to search place from google marker\n  };\n\n  /* VIEW MODEL*/\n  app.viewModel = {\n    //Selected place\n    placeDetails: ko.observable(),\n    isPlaceDetailsVisible: ko.observable(false),\n    hidePlaceDetails: () => { app.viewModel.isPlaceDetailsVisible(false) },\n\n    // error message\n    isFailureModalVisible: ko.observable(false),\n    hideFailureModal: () => { app.viewModel.isFailureModalVisible(false) },\n\n    textFilter: ko.observable(''),\n\n    filteredPlaces: ko.pureComputed(() => {\n      let text = app.viewModel.textFilter().trim().toLowerCase(),\n        places = app.model.places();\n      if (!text) return places;\n\n      return _.filter(places, place => place.name.toLowerCase().indexOf(text) !== -1);\n    }),\n\n    isPlacesNotLoaded: ko.pureComputed(() => {\n      let places = app.model.places();\n      return places.length === 0;\n    }),\n\n    // show spinner?\n    isLoading: ko.observable(false),\n    \n    isZoomedOut: ko.observable(false),\n\n    onClickPlace: app.controller.onClickPlace\n  };\n\n  /**\n   *  create a map, add map listener\n   */\n  function initApp() {\n    // init google map\n\n    const map = new google.maps.Map(document.getElementById('google-map'), GOOGLE_MAP_OPTIONS);\n    app.model.map = map;\n\n    // Try HTML5 geolocation\n    if (navigator.geolocation) {\n      navigator.geolocation.getCurrentPosition(function (position) {\n        var pos = {\n          lat: position.coords.latitude,\n          lng: position.coords.longitude\n        };\n\n        app.controller.removeAllPlaces();\n        map.setCenter(pos);\n      }, function () {\n        //handleLocationError\n      });\n    } else {\n      // Browser doesn't support Geolocation\n    }\n\n    map.addListener('bounds_changed', _.throttle(app.controller.loadPlaces, 2000));\n  }\n\n  /**\n   * load places from 4square\n   */\n  function loadPlaces() {\n    const map = app.model.map;\n    app.viewModel.isZoomedOut(map.zoom < 15);\n\n    // dont ask 4square on big areas\n    if (map.zoom < 15) return;\n\n    //distance between this point and last request\n    let distance = google.maps.geometry.spherical.computeDistanceBetween(lastQueryLocation, map.center);\n    // don't load new data if point is too close to previous search\n    if (distance < 1500) return;\n    lastQueryLocation = map.center;\n    app.viewModel.isLoading(true);\n\n    // load data from foursquare\n    //TODO idea, calculate radius from map zoom\n    const FoursquareRequestOptions = {\n      ll: map.center.lat() + ',' + map.center.lng(),\n      radius: 2000,\n      section: 'drinks',\n      client_id: 'E54BQ11LCWJ15Q0FH4MELITI2CZQ5KSJOU53TNRARJ3HHNXN',\n      client_secret: 'T4O0ZURMG00IGUTU4NKSQZ4DH0E5LGLMDAE20OJWPXMBD10Y',\n      v: 20160909\n    };\n    $.get('https://api.foursquare.com/v2/venues/explore', FoursquareRequestOptions, app.controller.addPlaces)\n      .fail(function () {\n        app.viewModel.isFailureModalVisible(true);\n      })\n      .always(function () {\n        app.viewModel.isLoading(false);\n      });\n  }\n\n  /**\n   * map place constructor\n   * @param item - one place from foursquare API response\n   * @constructor\n   */\n  function Place(item) {\n    const map = app.model.map;\n    const lat = item.venue.location.lat,\n      lng = item.venue.location.lng,\n      name = item.venue.name;\n\n    this.stash = item;\n    this.location = {lat, lng};\n    this.name = name;\n    this.isSelected = ko.observable(false);\n    this.marker = new google.maps.Marker({\n      map: map,\n      position: new google.maps.LatLng(lat, lng),\n      icon: G_MARKER,\n    });\n    this.marker.addListener('click', app.controller.onClickMarker);\n  }\n\n  /**\n   * add places to the map\n   * @param res - results from foursquare request\n   */\n  function addPlaces(res) {\n    //app.controller.removeAllPlaces();\n\n    res.response.groups[0].items.forEach(function (item) {\n      if (app.model.placesHash.has(item.venue.id)) return; // don't allow to double items on the map\n\n      const place = new Place(item);\n      app.model.places.push(place);\n      app.model.placesHash.set(item.venue.id, place);\n      app.model.markers.set(place.marker, place);\n\n    });\n\n    // not more than 150 markers on the map\n    let length = app.model.places().length;\n    if (length > 150) app.controller.removePlacesFromStart(length - 150);\n\n    app.viewModel.isLoading(false);\n  }\n\n  /**\n   * remove N places form the beginning of tha places array\n   * @param N\n   */\n  function removePlacesFromStart(N) {\n    let place;\n    for (let i = 0; i < N; i++) {\n      place = app.model.places.shift();\n      place.marker.setMap(null);\n      app.model.placesHash.delete(place.stash.venue.id);\n      if (app.viewModel.placeDetails() === place) app.viewModel.placeDetails(null);\n    }\n  }\n\n  function removeAllPlaces() {\n    let N = app.model.places().length;\n    app.controller.removePlacesFromStart(N);\n  }\n\n  /**\n   * user clicks on a place in the menu\n   * @param place\n   */\n  function onClickPlace(place) {\n    const oldSelected = app.viewModel.placeDetails();\n    if (oldSelected === place) return;\n\n    if(oldSelected) {\n      oldSelected.isSelected(false);\n      oldSelected.marker.setIcon(G_MARKER);\n    }\n\n    //add place to selected and show place details modal window\n    place.isSelected(true);\n    app.viewModel.placeDetails(place);\n    app.viewModel.isPlaceDetailsVisible(true);\n\n    // change marker icon and move map to this marker\n    place.marker.setIcon(G_MARKER_SELECTED);\n    app.model.map.panTo(place.location);\n\n    // hide side menu on small screens after click\n    if (window.matchMedia('(max-width: 426px)').matches) {\n      $('.mdl-layout__drawer').removeClass('is-visible');\n      $('.mdl-layout__obfuscator').removeClass('is-visible');\n    }\n  }\n\n  /**\n   * user clicks on a map marker\n   */\n  function onClickMarker() {\n    const place = app.model.markers.get(this);\n    app.controller.onClickPlace(place);\n  }\n\n  // init app after page loading\n  $(function () {\n    ko.applyBindings(app.viewModel);\n    app.controller.initApp();\n  });\n})();\n"],"sourceRoot":"/source/"}